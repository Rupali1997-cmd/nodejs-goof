name: CI/CD Security Pipeline

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:19.03.12
        options: --privileged

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Run Snyk SAST
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.3cde2b40-42ae-44f4-a13d-07f92a3dded9 }}
      with:
        command: test

    - name: Start App in Background
      run: |
        nohup npm start &
        sleep 10

    - name: Run OWASP ZAP Baseline Scan
      run: |
        docker run --network="host" -v $(pwd):/zap/wrk/:rw owasp/zap2docker-stable zap-baseline.py \
          -t http://localhost:3000 \
          -r zap-report.html \
          -J zap-report.json \
          -x zap-report.xml \
          -g zap.log \
          -I

    - name: Upload ZAP HTML Report
      uses: actions/upload-artifact@v3
      with:
        name: zap-report
        path: zap-report.html
